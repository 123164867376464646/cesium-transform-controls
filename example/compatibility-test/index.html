<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cesium Transform Controls - ÁâàÊú¨ÂÖºÂÆπÊÄßÊµãËØï</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #1a1a2e;
            color: #eee;
        }
        
        #cesiumContainer {
            width: 100%;
            height: 100vh;
        }
        
        .controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(30, 30, 50, 0.95);
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            min-width: 280px;
        }
        
        .controls h3 {
            margin-bottom: 15px;
            color: #4fc3f7;
            font-size: 14px;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }
        
        .version-info {
            background: #2a2a4a;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .version-info .label {
            color: #888;
            font-size: 12px;
        }
        
        .version-info .value {
            color: #4fc3f7;
            font-size: 18px;
            font-weight: bold;
        }
        
        .control-row {
            margin-bottom: 10px;
        }
        
        .control-row label {
            display: block;
            color: #aaa;
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .control-row select, .control-row button {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #333;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
        }
        
        .control-row select:hover, .control-row button:hover {
            border-color: #4fc3f7;
        }
        
        .control-row button {
            background: #4fc3f7;
            color: #1a1a2e;
            font-weight: bold;
            border: none;
        }
        
        .control-row button:hover {
            background: #29b6f6;
        }
        
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .status.success { background: #1b5e20; color: #a5d6a7; }
        .status.error { background: #b71c1c; color: #ffcdd2; }
        .status.loading { background: #1565c0; color: #bbdefb; }
        
        .test-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }
        
        .test-actions button {
            margin-bottom: 8px;
        }

        .info-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(30, 30, 50, 0.95);
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            min-width: 200px;
            font-size: 12px;
        }
        
        .info-panel h4 {
            color: #4fc3f7;
            margin-bottom: 10px;
            font-size: 13px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .info-row .label { color: #888; }
        .info-row .value { color: #fff; font-family: monospace; }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    
    <div class="controls">
        <h3>üß™ Cesium ÁâàÊú¨ÂÖºÂÆπÊÄßÊµãËØï</h3>
        
        <div class="version-info">
            <div class="label">ÂΩìÂâç Cesium ÁâàÊú¨</div>
            <div class="value" id="currentVersion">Âä†ËΩΩ‰∏≠...</div>
        </div>
        
        <div class="control-row">
            <label>ÈÄâÊã© Cesium ÁâàÊú¨</label>
            <select id="versionSelect">
                <option value="1.136.0">1.136.0 (ÊúÄÊñ∞)</option>
                <option value="1.135.0">1.135.0</option>
                <option value="1.130.0">1.130.0</option>
                <option value="1.125.0">1.125.0</option>
                <option value="1.121.0">1.121.0</option>
                <option value="1.120.0">1.120.0</option>
                <option value="1.119.0">1.119.0</option>
                <option value="1.118.0">1.118.0</option>
                <option value="1.117.0">1.117.0</option>
                <option value="1.116.0">1.116.0</option>
                <option value="1.115.0">1.115.0</option>
                <option value="1.114.0">1.114.0</option>
                <option value="1.113.0">1.113.0</option>
                <option value="1.110.0">1.110.0</option>
                <option value="1.105.0">1.105.0</option>
                <option value="1.100.0">1.100.0</option>
            </select>
        </div>
        
        <div class="control-row">
            <label>Ê®°ÂùóÊ†ºÂºè</label>
            <select id="moduleFormat">
                <option value="umd">UMD (‰º†Áªü)</option>
                <option value="esm">ESM (ES Modules)</option>
            </select>
        </div>
        
        <div class="control-row">
            <button id="switchVersion">üîÑ ÂàáÊç¢ÁâàÊú¨Âπ∂Âà∑Êñ∞</button>
        </div>
        
        <div class="test-actions">
            <div class="control-row">
                <label>Gizmo Ê®°Âºè</label>
                <select id="gizmoMode">
                    <option value="translate">Âπ≥Áßª (translate)</option>
                    <option value="rotate">ÊóãËΩ¨ (rotate)</option>
                    <option value="scale">Áº©Êîæ (scale)</option>
                </select>
            </div>
            <div class="control-row">
                <label>ÂùêÊ†áÁ≥ªÊ®°Âºè</label>
                <select id="coordMode">
                    <option value="local">Êú¨Âú∞ (local)</option>
                    <option value="surface">Âú∞Ë°® (surface)</option>
                </select>
            </div>
        </div>
        
        <div id="status" class="status loading">Ê≠£Âú®Âä†ËΩΩ...</div>
    </div>
    
    <div class="info-panel">
        <h4>üìä Ê®°Âûã‰ø°ÊÅØ</h4>
        <div class="info-row">
            <span class="label">ÂêçÁß∞:</span>
            <span class="value" id="infoName">-</span>
        </div>
        <div class="info-row">
            <span class="label">Á±ªÂûã:</span>
            <span class="value" id="infoType">-</span>
        </div>
        <div class="info-row">
            <span class="label">ÁªèÂ∫¶:</span>
            <span class="value" id="infoLon">-</span>
        </div>
        <div class="info-row">
            <span class="label">Á∫¨Â∫¶:</span>
            <span class="value" id="infoLat">-</span>
        </div>
        <div class="info-row">
            <span class="label">È´òÂ∫¶:</span>
            <span class="value" id="infoHeight">-</span>
        </div>
    </div>

    <!-- Âä®ÊÄÅÂä†ËΩΩËÑöÊú¨ -->
    <script>
        // ‰ªé URL ÂèÇÊï∞Ëé∑ÂèñÁâàÊú¨ÂíåÊ®°ÂùóÊ†ºÂºè
        const urlParams = new URLSearchParams(window.location.search);
        let cesiumVersion = urlParams.get('v') || '1.135.0';
        let moduleFormat = urlParams.get('format') || 'umd';
        
        // Êõ¥Êñ∞‰∏ãÊãâÊ°ÜÈÄâ‰∏≠È°π
        document.getElementById('versionSelect').value = cesiumVersion;
        document.getElementById('moduleFormat').value = moduleFormat;
        
        // ËæÖÂä©ÂáΩÊï∞ÔºöÂä®ÊÄÅÂä†ËΩΩËÑöÊú¨
        function loadScript(src, isModule = false) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                if (isModule) {
                    script.type = 'module';
                }
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // ËæÖÂä©ÂáΩÊï∞ÔºöÂä®ÊÄÅÂä†ËΩΩ CSS
        function loadCSS(href) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = href;
            document.head.appendChild(link);
        }
        
        // ËæÖÂä©ÂáΩÊï∞ÔºöÂä®ÊÄÅÊ≥®ÂÖ• Import MapÔºàESM Ê®°ÂºèÈúÄË¶ÅÔºâ
        function injectImportMap(version) {
            const importMap = {
                imports: {
                    "cesium": `https://cdn.jsdelivr.net/npm/cesium@${version}/+esm`
                }
            };
            const script = document.createElement('script');
            script.type = 'importmap';
            script.textContent = JSON.stringify(importMap);
            document.head.appendChild(script);
        }
        
        // Â¶ÇÊûúÊòØ ESM Ê®°ÂºèÔºåÊèêÂâçÊ≥®ÂÖ• Import Map
        if (moduleFormat === 'esm') {
            injectImportMap(cesiumVersion);
        }
        
        // UMD CDN ÂàóË°®ÔºàÊåâ‰ºòÂÖàÁ∫ßÊéíÂ∫èÔºâ
        const umdCdnList = [
            `https://cdn.jsdelivr.net/npm/cesium@${cesiumVersion}/Build/Cesium/Cesium.js`,
            `https://unpkg.com/cesium@${cesiumVersion}/Build/Cesium/Cesium.js`,
            `https://cesium.com/downloads/cesiumjs/releases/${cesiumVersion}/Build/Cesium/Cesium.js`,
        ];
        
        // ESM CDN ÂàóË°®
        const esmCdnList = [
            `https://cdn.jsdelivr.net/npm/cesium@${cesiumVersion}/+esm`,
        ];
        
        const cssCdnList = [
            `https://cdn.jsdelivr.net/npm/cesium@${cesiumVersion}/Build/Cesium/Widgets/widgets.css`,
            `https://unpkg.com/cesium@${cesiumVersion}/Build/Cesium/Widgets/widgets.css`,
            `https://cesium.com/downloads/cesiumjs/releases/${cesiumVersion}/Build/Cesium/Widgets/widgets.css`,
        ];
        
        // ÊåâÈ°∫Â∫èÂä†ËΩΩÊâÄÊúâ‰æùËµñ
        async function loadDependencies() {
            const statusEl = document.getElementById('status');
            const formatLabel = moduleFormat === 'esm' ? 'ESM' : 'UMD';
            
            // 1. Âä†ËΩΩ Cesium CSS
            loadCSS(cssCdnList[0]);
            
            if (moduleFormat === 'esm') {
                // ESM Âä†ËΩΩÊñπÂºè
                await loadDependenciesESM(statusEl, formatLabel);
            } else {
                // UMD Âä†ËΩΩÊñπÂºè
                await loadDependenciesUMD(statusEl, formatLabel);
            }
            
            // ÂàùÂßãÂåñÂ∫îÁî®
            await initApp();
        }
        
        // UMD Âä†ËΩΩÊñπÂºè
        async function loadDependenciesUMD(statusEl, formatLabel) {
            // Â∞ùËØï‰ªé‰∏çÂêå CDN Âä†ËΩΩ Cesium
            let cesiumLoaded = false;
            for (const cdn of umdCdnList) {
                try {
                    statusEl.textContent = `[${formatLabel}] Ê≠£Âú®‰ªé CDN Âä†ËΩΩ Cesium ${cesiumVersion}...`;
                    await loadScript(cdn);
                    console.log('Cesium loaded (UMD) from:', cdn);
                    cesiumLoaded = true;
                    break;
                } catch (e) {
                    console.warn('Failed to load from:', cdn);
                }
            }
            
            if (!cesiumLoaded) {
                throw new Error(`Êó†Ê≥ïÂä†ËΩΩ Cesium ${cesiumVersion}ÔºåÊâÄÊúâ CDN ÈÉΩÂ§±Ë¥•`);
            }
            
            // Âä†ËΩΩ Gizmo UMD
            statusEl.textContent = `[${formatLabel}] Ê≠£Âú®Âä†ËΩΩ CesiumTransformControls...`;
            await loadScript('../../dist/cesium-transform-controls.umd.js');
            console.log('CesiumTransformControls loaded (UMD)');
            
            // È™åËØÅÂä†ËΩΩÁªìÊûú
            if (typeof CesiumTransformControls === 'undefined' || !CesiumTransformControls.Gizmo) {
                throw new Error('CesiumTransformControls Âä†ËΩΩÂ§±Ë¥•ÊàñÁªìÊûÑ‰∏çÊ≠£Á°Æ');
            }
        }
        
        // ESM Âä†ËΩΩÊñπÂºè
        async function loadDependenciesESM(statusEl, formatLabel) {
            statusEl.textContent = `[${formatLabel}] Ê≠£Âú®‰ªé CDN Âä†ËΩΩ Cesium ${cesiumVersion}...`;
            
            try {
                // ‰ΩøÁî®Âä®ÊÄÅ import Âä†ËΩΩ ESM ÁâàÊú¨ÁöÑ Cesium
                const esmUrl = esmCdnList[0];
                console.log('Loading Cesium ESM from:', esmUrl);
                
                const CesiumModule = await import(esmUrl);
                
                // ESM ÂØºÂÖ•ÂêéÔºåÂ∞Ü Cesium ÊåÇËΩΩÂà∞ÂÖ®Â±Ä
                window.Cesium = CesiumModule.default || CesiumModule;
                
                // ËÆæÁΩÆ CESIUM_BASE_URLÔºàESM ÁâàÊú¨ÈúÄË¶ÅÊâãÂä®ËÆæÁΩÆÔºâ
                window.CESIUM_BASE_URL = `https://cdn.jsdelivr.net/npm/cesium@${cesiumVersion}/Build/Cesium/`;
                
                console.log('Cesium loaded (ESM), version:', window.Cesium.VERSION);
                
            } catch (e) {
                console.error('ESM load error:', e);
                throw new Error(`ESM Âä†ËΩΩ Cesium ${cesiumVersion} Â§±Ë¥•: ${e.message}`);
            }
            
            // Âä†ËΩΩ Gizmo ESM
            statusEl.textContent = `[${formatLabel}] Ê≠£Âú®Âä†ËΩΩ CesiumTransformControls...`;
            try {
                const GizmoModule = await import('../../dist/cesium-transform-controls.es.js');
                
                // Â∞ÜÂØºÂá∫ÊåÇËΩΩÂà∞ÂÖ®Â±Ä
                window.CesiumTransformControls = GizmoModule;
                console.log('CesiumTransformControls loaded (ESM)');
                
            } catch (e) {
                console.error('Gizmo ESM load error:', e);
                throw new Error(`ESM Âä†ËΩΩ CesiumTransformControls Â§±Ë¥•: ${e.message}`);
            }
            
            // È™åËØÅÂä†ËΩΩÁªìÊûú
            if (!window.CesiumTransformControls || !window.CesiumTransformControls.Gizmo) {
                throw new Error('CesiumTransformControls Âä†ËΩΩÂ§±Ë¥•ÊàñÁªìÊûÑ‰∏çÊ≠£Á°Æ');
            }
        }
        
        // ÂàáÊç¢ÁâàÊú¨/Ê†ºÂºè
        document.getElementById('switchVersion').onclick = () => {
            const newVersion = document.getElementById('versionSelect').value;
            const newFormat = document.getElementById('moduleFormat').value;
            window.location.href = `?v=${newVersion}&format=${newFormat}`;
        };
        
        // ÂêØÂä®Âä†ËΩΩÊµÅÁ®ã
        loadDependencies().catch(err => {
            console.error('Âä†ËΩΩÂ§±Ë¥•:', err);
            document.getElementById('status').className = 'status error';
            document.getElementById('status').textContent = `‚ùå ${err.message}`;
        });
    </script>
    
    <script>
        let viewer, model, gizmo;
        
        async function initApp() {
            try {
                document.getElementById('currentVersion').textContent = cesiumVersion;
                document.getElementById('status').className = 'status loading';
                document.getElementById('status').textContent = 'Ê≠£Âú®ÂàùÂßãÂåñ Cesium...';
                
                // Ê£ÄÊü• Cesium ÊòØÂê¶Âä†ËΩΩÊàêÂäü
                if (typeof Cesium === 'undefined') {
                    throw new Error('Cesium Êú™Âä†ËΩΩ');
                }
                console.log('Cesium ÁâàÊú¨:', Cesium.VERSION);
                
                // Ê£ÄÊü• cesium-transform-controls ÊòØÂê¶Âä†ËΩΩÊàêÂäü
                if (typeof CesiumTransformControls === 'undefined') {
                    throw new Error('CesiumTransformControls Êú™Âä†ËΩΩ');
                }
                console.log('CesiumTransformControls:', CesiumTransformControls);
                
                // ÂàùÂßãÂåñ Viewer
                viewer = new Cesium.Viewer('cesiumContainer', {
                    baseLayerPicker: false,
                    geocoder: false,
                    homeButton: false,
                    sceneModePicker: false,
                    navigationHelpButton: false,
                    animation: false,
                    timeline: false,
                    infoBox: false,
                });
                
                document.getElementById('status').textContent = 'Ê≠£Âú®Âä†ËΩΩÊ®°Âûã...';
                
                const baseLon = 106.58446188;
                const baseLat = 29.57088337;
                const baseHeight = 0;
                
                // Âä†ËΩΩÊ®°Âûã
                model = await Cesium.Model.fromGltfAsync({
                    url: '../public/luaz.glb',
                    modelMatrix: Cesium.Transforms.headingPitchRollToFixedFrame(
                        Cesium.Cartesian3.fromDegrees(baseLon, baseLat, baseHeight),
                        new Cesium.HeadingPitchRoll(0, 0, 0)
                    ),
                    scale: 10,
                });
                viewer.scene.primitives.add(model);
                
                // Á≠âÂæÖÊ®°ÂûãÂ∞±Áª™
                await new Promise((resolve) => {
                    model.readyEvent.addEventListener(resolve);
                });
                
                document.getElementById('status').textContent = 'Ê≠£Âú®ÂàùÂßãÂåñ Gizmo...';
                
                // ÂàùÂßãÂåñ Gizmo
                const { Gizmo, GizmoMode, CoordinateMode } = CesiumTransformControls;
                
                gizmo = new Gizmo({
                    onGizmoPointerMove: () => updateInfo(),
                });
                gizmo.attach(viewer);
                
                // ÊåÇËΩΩÂà∞Â≠êËäÇÁÇπ
                const nodeName = 'door_R_luaz_diffuse_0';
                const node = model.getNode(nodeName);
                if (node) {
                    gizmo.mountToNode(node, model, viewer);
                } else {
                    gizmo.mountToPrimitive(model, viewer);
                }
                
                // È£ûÂà∞Ê®°Âûã
                const boundingSphere = model.boundingSphere;
                viewer.camera.flyToBoundingSphere(boundingSphere, {
                    duration: 0,
                    offset: new Cesium.HeadingPitchRange(
                        Cesium.Math.toRadians(-45),
                        Cesium.Math.toRadians(-15),
                        boundingSphere.radius * 3
                    ),
                });
                
                // ÁªëÂÆöÊ®°ÂºèÂàáÊç¢
                document.getElementById('gizmoMode').onchange = (e) => {
                    const mode = e.target.value;
                    switch (mode) {
                        case 'translate': gizmo.setMode(GizmoMode.translate); break;
                        case 'rotate': gizmo.setMode(GizmoMode.rotate); break;
                        case 'scale': gizmo.setMode(GizmoMode.scale); break;
                    }
                };
                
                document.getElementById('coordMode').onchange = (e) => {
                    const mode = e.target.value;
                    gizmo.coordinateMode = mode === 'surface' ? CoordinateMode.surface : CoordinateMode.local;
                };
                
                // Êõ¥Êñ∞‰ø°ÊÅØ
                updateInfo();
                viewer.scene.preRender.addEventListener(updateInfo);
                
                document.getElementById('status').className = 'status success';
                const formatLabel = moduleFormat === 'esm' ? 'ESM' : 'UMD';
                document.getElementById('status').textContent = `‚úÖ [${formatLabel}] Cesium ${cesiumVersion} + Gizmo Âä†ËΩΩÊàêÂäü!`;
                
                // ÂØºÂá∫Âà∞ÂÖ®Â±Ä‰æø‰∫éË∞ÉËØï
                window.viewer = viewer;
                window.model = model;
                window.gizmo = gizmo;
                window.Cesium = Cesium;
                
            } catch (error) {
                console.error('ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                document.getElementById('status').className = 'status error';
                document.getElementById('status').textContent = `‚ùå ÈîôËØØ: ${error.message}`;
            }
        }
        
        function updateInfo() {
            if (!gizmo || !gizmo._mountedPrimitive) return;
            
            const mounted = gizmo._mountedPrimitive;
            
            // ÂêçÁß∞ÂíåÁ±ªÂûã
            let name = '-', type = '-';
            if (mounted._isNode && mounted._node) {
                name = mounted._node.name || 'ModelNode';
                type = 'ModelNode';
            } else if (mounted instanceof Cesium.Model) {
                name = 'luaz.glb';
                type = 'Model';
            }
            
            document.getElementById('infoName').textContent = name;
            document.getElementById('infoType').textContent = type;
            
            // ‰ΩçÁΩÆ
            try {
                const position = Cesium.Matrix4.getTranslation(mounted.modelMatrix, new Cesium.Cartesian3());
                const carto = Cesium.Cartographic.fromCartesian(position);
                if (carto) {
                    document.getElementById('infoLon').textContent = Cesium.Math.toDegrees(carto.longitude).toFixed(6);
                    document.getElementById('infoLat').textContent = Cesium.Math.toDegrees(carto.latitude).toFixed(6);
                    document.getElementById('infoHeight').textContent = carto.height.toFixed(2) + 'm';
                }
            } catch (e) {}
        }
    </script>
</body>
</html>
