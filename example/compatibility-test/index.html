<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cesium Transform Controls - ç‰ˆæœ¬å…¼å®¹æ€§æµ‹è¯•</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #1a1a2e;
            color: #eee;
        }
        
        #cesiumContainer {
            width: 100%;
            height: 100vh;
        }
        
        .controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(30, 30, 50, 0.95);
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            min-width: 280px;
        }
        
        .controls h3 {
            margin-bottom: 15px;
            color: #4fc3f7;
            font-size: 14px;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }
        
        .version-info {
            background: #2a2a4a;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .version-info .label {
            color: #888;
            font-size: 12px;
        }
        
        .version-info .value {
            color: #4fc3f7;
            font-size: 18px;
            font-weight: bold;
        }
        
        .control-row {
            margin-bottom: 10px;
        }
        
        .control-row label {
            display: block;
            color: #aaa;
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .control-row select, .control-row button {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #333;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
        }
        
        .control-row select:hover, .control-row button:hover {
            border-color: #4fc3f7;
        }
        
        .control-row button {
            background: #4fc3f7;
            color: #1a1a2e;
            font-weight: bold;
            border: none;
        }
        
        .control-row button:hover {
            background: #29b6f6;
        }
        
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .status.success { background: #1b5e20; color: #a5d6a7; }
        .status.error { background: #b71c1c; color: #ffcdd2; }
        .status.loading { background: #1565c0; color: #bbdefb; }
        
        .test-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }
        
        .test-actions button {
            margin-bottom: 8px;
        }

        .info-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(30, 30, 50, 0.95);
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            min-width: 200px;
            font-size: 12px;
        }
        
        .info-panel h4 {
            color: #4fc3f7;
            margin-bottom: 10px;
            font-size: 13px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .info-row .label { color: #888; }
        .info-row .value { color: #fff; font-family: monospace; }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    
    <div class="controls">
        <h3>ğŸ§ª Cesium ç‰ˆæœ¬å…¼å®¹æ€§æµ‹è¯•</h3>
        
        <div class="version-info">
            <div class="label">å½“å‰ Cesium ç‰ˆæœ¬</div>
            <div class="value" id="currentVersion">åŠ è½½ä¸­...</div>
        </div>
        
        <div class="control-row">
            <label>é€‰æ‹© Cesium ç‰ˆæœ¬</label>
            <select id="versionSelect">
                <option value="" disabled>æ­£åœ¨åŠ è½½ç‰ˆæœ¬...</option>

            </select>
        </div>
        
        <div class="control-row">
            <label>æ¨¡å—æ ¼å¼</label>
            <select id="moduleFormat">
                <option value="umd">UMD (ä¼ ç»Ÿ)</option>
                <option value="esm">ESM (ES Modules)</option>
            </select>
        </div>
        
        <div class="control-row">
            <button id="switchVersion">ğŸ”„ åˆ‡æ¢ç‰ˆæœ¬å¹¶åˆ·æ–°</button>
        </div>
        
        <div class="test-actions">
            <div class="control-row">
                <label>Gizmo æ¨¡å¼</label>
                <select id="gizmoMode">
                    <option value="translate">å¹³ç§» (translate)</option>
                    <option value="rotate">æ—‹è½¬ (rotate)</option>
                    <option value="scale">ç¼©æ”¾ (scale)</option>
                </select>
            </div>
            <div class="control-row">
                <label>åæ ‡ç³»æ¨¡å¼</label>
                <select id="coordMode">
                    <option value="local">æœ¬åœ° (local)</option>
                    <option value="surface">åœ°è¡¨ (surface)</option>
                </select>
            </div>
        </div>
        
        <div id="status" class="status loading">æ­£åœ¨åŠ è½½...</div>
    </div>
    
    <div class="info-panel">
        <h4>ğŸ“Š æ¨¡å‹ä¿¡æ¯</h4>
        <div class="info-row">
            <span class="label">åç§°:</span>
            <span class="value" id="infoName">-</span>
        </div>
        <div class="info-row">
            <span class="label">ç±»å‹:</span>
            <span class="value" id="infoType">-</span>
        </div>
        <div class="info-row">
            <span class="label">ç»åº¦:</span>
            <span class="value" id="infoLon">-</span>
        </div>
        <div class="info-row">
            <span class="label">çº¬åº¦:</span>
            <span class="value" id="infoLat">-</span>
        </div>
        <div class="info-row">
            <span class="label">é«˜åº¦:</span>
            <span class="value" id="infoHeight">-</span>
        </div>
    </div>

    <!-- åŠ¨æ€åŠ è½½è„šæœ¬ -->
    <script>
        // ä» URL å‚æ•°è·å–ç‰ˆæœ¬å’Œæ¨¡å—æ ¼å¼
        const urlParams = new URLSearchParams(window.location.search);
        let cesiumVersion = urlParams.get('v') || '1.135.0';
        let moduleFormat = urlParams.get('format') || 'umd';
        
        // æ›´æ–°ä¸‹æ‹‰æ¡†é€‰ä¸­é¡¹
        document.getElementById('versionSelect').value = cesiumVersion;
        document.getElementById('moduleFormat').value = moduleFormat;
        
        // è¾…åŠ©å‡½æ•°ï¼šåŠ¨æ€åŠ è½½è„šæœ¬
        function loadScript(src, isModule = false) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                if (isModule) {
                    script.type = 'module';
                }
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šåŠ¨æ€åŠ è½½ CSS
        function loadCSS(href) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = href;
            document.head.appendChild(link);
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šåŠ¨æ€æ³¨å…¥ Import Mapï¼ˆESM æ¨¡å¼éœ€è¦ï¼‰
        function injectImportMap(version) {
            const importMap = {
                imports: {
                    "cesium": `https://cdn.jsdelivr.net/npm/cesium@${version}/+esm`
                }
            };
            const script = document.createElement('script');
            script.type = 'importmap';
            script.textContent = JSON.stringify(importMap);
            document.head.appendChild(script);
        }
        
        // å¦‚æœæ˜¯ ESM æ¨¡å¼ï¼Œæå‰æ³¨å…¥ Import Map
        if (moduleFormat === 'esm') {
            injectImportMap(cesiumVersion);
        }
        
        // å·²ç§»é™¤é™æ€ CDN åˆ—è¡¨ï¼Œæ”¹ä¸ºåœ¨ loadDependencies ä¸­åŠ¨æ€ç”Ÿæˆ

        
        // æŒ‰é¡ºåºåŠ è½½æ‰€æœ‰ä¾èµ–
        async function loadDependencies() {
            const statusEl = document.getElementById('status');
            const formatLabel = moduleFormat === 'esm' ? 'ESM' : 'UMD';
            
            const cssUrl = `https://cdn.jsdelivr.net/npm/cesium@${cesiumVersion}/Build/Cesium/Widgets/widgets.css`;

            // 1. åŠ è½½ Cesium CSS
            loadCSS(cssUrl);
            
            if (moduleFormat === 'esm') {
                // ESM åŠ è½½æ–¹å¼
                await loadDependenciesESM(statusEl, formatLabel);
            } else {
                // UMD åŠ è½½æ–¹å¼
                await loadDependenciesUMD(statusEl, formatLabel);
            }
            
            // åˆå§‹åŒ–åº”ç”¨
            await initApp();
        }
        
        // UMD åŠ è½½æ–¹å¼
        async function loadDependenciesUMD(statusEl, formatLabel) {
            const umdCdnList = [
                `https://cdn.jsdelivr.net/npm/cesium@${cesiumVersion}/Build/Cesium/Cesium.js`,
                `https://unpkg.com/cesium@${cesiumVersion}/Build/Cesium/Cesium.js`,
                `https://cesium.com/downloads/cesiumjs/releases/${cesiumVersion}/Build/Cesium/Cesium.js`,
            ];

            // å°è¯•ä»ä¸åŒ CDN åŠ è½½ Cesium
            let cesiumLoaded = false;
            for (const cdn of umdCdnList) {
                try {
                    statusEl.textContent = `[${formatLabel}] æ­£åœ¨ä» CDN åŠ è½½ Cesium ${cesiumVersion}...`;
                    await loadScript(cdn);
                    console.log('Cesium loaded (UMD) from:', cdn);
                    cesiumLoaded = true;
                    break;
                } catch (e) {
                    console.warn('Failed to load from:', cdn);
                }
            }
            
            if (!cesiumLoaded) {
                throw new Error(`æ— æ³•åŠ è½½ Cesium ${cesiumVersion}ï¼Œæ‰€æœ‰ CDN éƒ½å¤±è´¥`);
            }
            
            // åŠ è½½ Gizmo UMD
            statusEl.textContent = `[${formatLabel}] æ­£åœ¨åŠ è½½ CesiumTransformControls...`;
            await loadScript('../../dist/cesium-transform-controls.umd.js');
            console.log('CesiumTransformControls loaded (UMD)');
            
            // éªŒè¯åŠ è½½ç»“æœ
            if (typeof CesiumTransformControls === 'undefined' || !CesiumTransformControls.Gizmo) {
                throw new Error('CesiumTransformControls åŠ è½½å¤±è´¥æˆ–ç»“æ„ä¸æ­£ç¡®');
            }
        }
        
        // ESM åŠ è½½æ–¹å¼
        async function loadDependenciesESM(statusEl, formatLabel) {
            statusEl.textContent = `[${formatLabel}] æ­£åœ¨ä» CDN åŠ è½½ Cesium ${cesiumVersion}...`;
            
            try {
                // ä½¿ç”¨åŠ¨æ€ import åŠ è½½ ESM ç‰ˆæœ¬çš„ Cesium
                const esmUrl = `https://cdn.jsdelivr.net/npm/cesium@${cesiumVersion}/+esm`;
                console.log('Loading Cesium ESM from:', esmUrl);
                
                const CesiumModule = await import(esmUrl);
                
                // ESM å¯¼å…¥åï¼Œå°† Cesium æŒ‚è½½åˆ°å…¨å±€
                window.Cesium = CesiumModule.default || CesiumModule;
                
                // è®¾ç½® CESIUM_BASE_URLï¼ˆESM ç‰ˆæœ¬éœ€è¦æ‰‹åŠ¨è®¾ç½®ï¼‰
                window.CESIUM_BASE_URL = `https://cdn.jsdelivr.net/npm/cesium@${cesiumVersion}/Build/Cesium/`;
                
                console.log('Cesium loaded (ESM), version:', window.Cesium.VERSION);
                
            } catch (e) {
                console.error('ESM load error:', e);
                throw new Error(`ESM åŠ è½½ Cesium ${cesiumVersion} å¤±è´¥: ${e.message}`);
            }
            
            // åŠ è½½ Gizmo ESM
            statusEl.textContent = `[${formatLabel}] æ­£åœ¨åŠ è½½ CesiumTransformControls...`;
            try {
                const GizmoModule = await import('../../dist/cesium-transform-controls.es.js');
                
                // å°†å¯¼å‡ºæŒ‚è½½åˆ°å…¨å±€
                window.CesiumTransformControls = GizmoModule;
                console.log('CesiumTransformControls loaded (ESM)');
                
            } catch (e) {
                console.error('Gizmo ESM load error:', e);
                throw new Error(`ESM åŠ è½½ CesiumTransformControls å¤±è´¥: ${e.message}`);
            }
            
            // éªŒè¯åŠ è½½ç»“æœ
            if (!window.CesiumTransformControls || !window.CesiumTransformControls.Gizmo) {
                throw new Error('CesiumTransformControls åŠ è½½å¤±è´¥æˆ–ç»“æ„ä¸æ­£ç¡®');
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šè¯­ä¹‰åŒ–ç‰ˆæœ¬æ¯”è¾ƒ (ç®€å•çš„å®ç°ï¼Œè¶³ä»¥å¤„ç† Cesium ç‰ˆæœ¬)
        function compareVersions(a, b) {
            const pa = a.split('.').map(Number);
            const pb = b.split('.').map(Number);
            for (let i = 0; i < 3; i++) {
                const na = pa[i] || 0;
                const nb = pb[i] || 0;
                if (na > nb) return 1;
                if (na < nb) return -1;
            }
            return 0;
        }

        // è·å– Cesium ç‰ˆæœ¬åˆ—è¡¨
        async function fetchVersions() {
            const select = document.getElementById('versionSelect');
            const statusEl = document.getElementById('status');
            
            // æ·»åŠ ä¸´æ—¶åŠ è½½çŠ¶æ€
            const loadingOption = document.createElement('option');
            loadingOption.text = "æ­£åœ¨è·å–ç‰ˆæœ¬åˆ—è¡¨...";
            select.add(loadingOption);
            
            try {
                // å°è¯•ä» npm registry è·å–
                // æ³¨æ„ï¼šè¿™é‡Œå¯èƒ½ä¼šæœ‰è·¨åŸŸé—®é¢˜ï¼Œå¦‚æœç›´æ¥ä»æµè§ˆå™¨è®¿é—® registry.npmjs.org
                // ä½†é€šå¸¸ npm registry æ”¯æŒ CORSã€‚å¦‚æœä¸è¡Œï¼Œå¯ä»¥ä½¿ç”¨ jsdelivr çš„æ•°æ®
                const response = await fetch('https://registry.npmjs.org/cesium');
                if (!response.ok) throw new Error('æ— æ³•è¿æ¥åˆ° NPM Registry');
                
                const data = await response.json();
                const versions = Object.keys(data.versions).sort((a, b) => compareVersions(b, a)); // é™åº
                
                // è¿‡æ»¤æ‰è¿‡æ—§çš„ç‰ˆæœ¬ï¼Œåªä¿ç•™æœ€è¿‘çš„ n ä¸ªï¼Œæˆ–è€…ä¿ç•™æ‰€æœ‰ 1.x ç‰ˆæœ¬
                const recentVersions = versions.filter(v => v.startsWith('1.')).slice(0, 50);

                select.innerHTML = ''; // æ¸…ç©º
                
                recentVersions.forEach((v, index) => {
                    const option = document.createElement('option');
                    option.value = v;
                    option.textContent = v + (index === 0 ? ' (æœ€æ–°)' : '');
                    select.appendChild(option);
                });
                
                // è®¾ç½®é€‰ä¸­å€¼
                // å¦‚æœ URL å‚æ•°ä¸­æœ‰ç‰ˆæœ¬ï¼Œå°è¯•é€‰ä¸­å®ƒ
                // å¦‚æœæ²¡æœ‰ï¼Œæˆ–è€… URL å‚æ•°çš„ç‰ˆæœ¬ä¸åœ¨åˆ—è¡¨ä¸­ï¼ˆå¯èƒ½æ˜¯éå¸¸æ—§çš„ç‰ˆæœ¬ï¼‰ï¼Œä¿ç•™ URL å‚æ•°çš„å€¼ï¼ˆå¦‚æœç”¨æˆ·æ‰‹åŠ¨æŒ‡å®šäº†ï¼‰
                // ç°åœ¨çš„é€»è¾‘ï¼š
                // 1. å¦‚æœ urlParams æœ‰ vï¼Œä¼˜å…ˆä½¿ç”¨
                // 2. å¦‚æœæ²¡æœ‰ï¼Œä½¿ç”¨åˆ—è¡¨ç¬¬ä¸€ä¸ªï¼ˆæœ€æ–°ï¼‰
                
                let targetVersion = urlParams.get('v');
                if (!targetVersion && recentVersions.length > 0) {
                    targetVersion = recentVersions[0];
                }
                
                // å¦‚æœç›®æ ‡ç‰ˆæœ¬ä¸åœ¨ä¸‹æ‹‰åˆ—è¡¨ä¸­ï¼ˆä¾‹å¦‚æ‰‹åŠ¨è¾“å…¥äº†ä¸€ä¸ªæ—§ç‰ˆæœ¬ï¼‰ï¼Œæ·»åŠ è¿›å»
                if (targetVersion && !Array.from(select.options).some(op => op.value === targetVersion)) {
                    const option = document.createElement('option');
                    option.value = targetVersion;
                    option.textContent = targetVersion + ' (è‡ªå®šä¹‰)';
                    select.insertBefore(option, select.firstChild);
                }
                
                select.value = targetVersion;
                
                // æ›´æ–°å…¨å±€å˜é‡ï¼Œä»¥ä¾¿åç»­åŠ è½½è„šæœ¬ä½¿ç”¨
                cesiumVersion = targetVersion;
                document.getElementById('currentVersion').textContent = cesiumVersion;
                
            } catch (e) {
                console.error('è·å–ç‰ˆæœ¬åˆ—è¡¨å¤±è´¥:', e);
                // å¤±è´¥å›é€€é€»è¾‘ï¼šä¿ç•™ HTML ä¸­ç¡¬ç¼–ç çš„æˆ–è€…æä¾›ä¸€ä¸ªåŸºç¡€åˆ—è¡¨
                // ç”±äºæˆ‘ä»¬æ¸…ç©ºäº† HTMLï¼Œè¿™é‡Œéœ€è¦æ¢å¤ä¸€äº›å¹¶åœ¨çŠ¶æ€æ æç¤º
                select.innerHTML = '';
                const backups = ['1.126.0', '1.125.0', '1.121.0', '1.100.0'];
                backups.forEach(v => {
                    const option = document.createElement('option');
                    option.value = v;
                    option.textContent = v;
                    select.appendChild(option);
                });
                
                // æç¤ºç”¨æˆ·
                const errorOption = document.createElement('option');
                errorOption.text = "è·å–å¤±è´¥ (ä½¿ç”¨ç¦»çº¿åˆ—è¡¨)";
                errorOption.disabled = true;
                select.insertBefore(errorOption, select.firstChild);
                
                // å³ä¾¿è·å–å¤±è´¥ï¼Œä¹Ÿéœ€è¦è®¾ç½®ç‰ˆæœ¬ä»¥ä¾¿ç»§ç»­åŠ è½½
                if (!cesiumVersion) cesiumVersion = '1.126.0';
                select.value = cesiumVersion;
                document.getElementById('currentVersion').textContent = cesiumVersion;
            }
        }

        // åˆ‡æ¢ç‰ˆæœ¬/æ ¼å¼
        document.getElementById('switchVersion').onclick = () => {
            const newVersion = document.getElementById('versionSelect').value;
            const newFormat = document.getElementById('moduleFormat').value;
            window.location.href = `?v=${newVersion}&format=${newFormat}`;
        };

        // å¯åŠ¨æµç¨‹ï¼šå…ˆè·å–ç‰ˆæœ¬ï¼Œå†åŠ è½½ä¾èµ–
        (async () => {
            await fetchVersions();
            
            // é‡æ–°è·å–ä¸€ä¸‹ï¼ˆå› ä¸º fetchVersions å¯èƒ½ä¼šæ›´æ–° cesiumVersionï¼‰
            // å…¶å® fetchVersions å†…éƒ¨å·²ç»æ›´æ–°äº† cesiumVersion å˜é‡ï¼Œä½†ä¸ºäº†ä¿é™©
            cesiumVersion = document.getElementById('versionSelect').value; 
            
            // å¦‚æœæ˜¯ ESMï¼Œéœ€è¦æ³¨å…¥ Import Map (ç‰ˆæœ¬å·ç¡®å®šå)
            if (moduleFormat === 'esm') {
                 // æ¸…é™¤å¯èƒ½æ—§çš„ï¼Œè™½ç„¶è¿™é‡Œæ˜¯é¦–æ¬¡åŠ è½½
                 // æ³¨æ„ï¼šimportmap å¿…é¡»åœ¨ä»»ä½• ES module è„šæœ¬åŠ è½½ç”šè‡³è§£æä¹‹å‰å­˜åœ¨
                 // ä½†æˆ‘ä»¬åœ¨ loadDependencies æ‰ä¼šåŠ¨æ€åŠ è½½æ¨¡å—ï¼Œæ‰€ä»¥è¿™é‡Œæ³¨å…¥æ˜¯å¯ä»¥çš„
                 injectImportMap(cesiumVersion);
            }
            
            // ç°åœ¨æ›´æ–° CDN åˆ—è¡¨ä¸­çš„ç‰ˆæœ¬å·
            updateCdnLists();

            loadDependencies().catch(err => {
                console.error('åŠ è½½å¤±è´¥:', err);
                document.getElementById('status').className = 'status error';
                document.getElementById('status').textContent = `âŒ ${err.message}`;
            });
        })();

        function updateCdnLists() {
             // å¿…é¡»é‡æ–°å®šä¹‰è¿™äº›åˆ—è¡¨ï¼Œå› ä¸ºå®ƒä»¬æœ€åˆæ˜¯ç”¨é»˜è®¤ç‰ˆæœ¬åˆå§‹åŒ–çš„
             // æ›´å¥½çš„åšæ³•æ˜¯æŠŠè¿™äº›åˆ—è¡¨æ”¹ä¸ºå‡½æ•°æˆ–åœ¨ç”¨åˆ°æ—¶åŠ¨æ€ç”Ÿæˆï¼Œè¿™é‡Œç®€å•ç‚¹ç›´æ¥ä¿®æ”¹å…¨å±€æ•°ç»„ï¼ˆå¦‚æœå®ƒä»¬æ˜¯ letï¼‰
             // ä½†ä¸Šé¢æ˜¯ constï¼Œæ‰€ä»¥æˆ‘ä»¬ç¨å¾®é‡æ„ä¸€ä¸‹ loadDependencies é‡Œçš„é€»è¾‘ï¼Œè®©å®ƒç›´æ¥ä½¿ç”¨ cesiumVersion
             // æˆ–è€…åœ¨è¿™é‡Œä¿®æ”¹æ•°ç»„å†…å®¹ï¼ˆè™½ç„¶ä¸æ¨èæ”¹ const æ•°ç»„å†…å®¹ï¼Œä½† strings æ˜¯ immutable çš„ï¼Œæ— æ³•æ›¿æ¢æ•°ç»„å…ƒç´ å¼•ç”¨ï¼‰
             // ï¼ï¼ï¼æ³¨æ„ï¼šä¸Šé¢çš„å®šä¹‰æ˜¯ const umdCdnList = [...]ï¼Œæˆ‘ä»¬æ— æ³•é‡æ–°èµ‹å€¼ã€‚
             // å¿…é¡»å»ä¿®æ”¹ä¸Šé¢çš„å®šä¹‰ä¸º let æˆ–è€…åœ¨ loadDependencies é‡ŒåŠ¨æ€æ„å»º URLã€‚
             
             // è®©æˆ‘ä»¬ä¿®æ”¹ loadDependencies èƒ½å¤ŸåŠ¨æ€ä½¿ç”¨ cesiumVersion
        }
    </script>
    
    <script>
        let viewer, model, gizmo;
        
        async function initApp() {
            try {
                document.getElementById('currentVersion').textContent = cesiumVersion;
                document.getElementById('status').className = 'status loading';
                document.getElementById('status').textContent = 'æ­£åœ¨åˆå§‹åŒ– Cesium...';
                
                // æ£€æŸ¥ Cesium æ˜¯å¦åŠ è½½æˆåŠŸ
                if (typeof Cesium === 'undefined') {
                    throw new Error('Cesium æœªåŠ è½½');
                }
                console.log('Cesium ç‰ˆæœ¬:', Cesium.VERSION);
                
                // æ£€æŸ¥ cesium-transform-controls æ˜¯å¦åŠ è½½æˆåŠŸ
                if (typeof CesiumTransformControls === 'undefined') {
                    throw new Error('CesiumTransformControls æœªåŠ è½½');
                }
                console.log('CesiumTransformControls:', CesiumTransformControls);
                
                // åˆå§‹åŒ– Viewer
                viewer = new Cesium.Viewer('cesiumContainer', {
                    baseLayerPicker: false,
                    geocoder: false,
                    homeButton: false,
                    sceneModePicker: false,
                    navigationHelpButton: false,
                    animation: false,
                    timeline: false,
                    infoBox: false,
                });
                
                document.getElementById('status').textContent = 'æ­£åœ¨åŠ è½½æ¨¡å‹...';
                
                const baseLon = 106.58446188;
                const baseLat = 29.57088337;
                const baseHeight = 0;
                
                // åŠ è½½æ¨¡å‹
                model = await Cesium.Model.fromGltfAsync({
                    url: '../public/luaz.glb',
                    modelMatrix: Cesium.Transforms.headingPitchRollToFixedFrame(
                        Cesium.Cartesian3.fromDegrees(baseLon, baseLat, baseHeight),
                        new Cesium.HeadingPitchRoll(0, 0, 0)
                    ),
                    scale: 10,
                });
                viewer.scene.primitives.add(model);
                
                // ç­‰å¾…æ¨¡å‹å°±ç»ª
                await new Promise((resolve) => {
                    model.readyEvent.addEventListener(resolve);
                });
                
                document.getElementById('status').textContent = 'æ­£åœ¨åˆå§‹åŒ– Gizmo...';
                
                // åˆå§‹åŒ– Gizmo
                const { Gizmo, GizmoMode, CoordinateMode } = CesiumTransformControls;
                
                gizmo = new Gizmo({
                    onGizmoPointerMove: () => updateInfo(),
                });
                gizmo.attach(viewer);
                
                // æŒ‚è½½åˆ°å­èŠ‚ç‚¹
                const nodeName = 'door_R_luaz_diffuse_0';
                const node = model.getNode(nodeName);
                if (node) {
                    gizmo.mountToNode(node, model, viewer);
                } else {
                    gizmo.mountToPrimitive(model, viewer);
                }
                
                // é£åˆ°æ¨¡å‹
                const boundingSphere = model.boundingSphere;
                viewer.camera.flyToBoundingSphere(boundingSphere, {
                    duration: 0,
                    offset: new Cesium.HeadingPitchRange(
                        Cesium.Math.toRadians(-45),
                        Cesium.Math.toRadians(-15),
                        boundingSphere.radius * 3
                    ),
                });
                
                // ç»‘å®šæ¨¡å¼åˆ‡æ¢
                document.getElementById('gizmoMode').onchange = (e) => {
                    const mode = e.target.value;
                    switch (mode) {
                        case 'translate': gizmo.setMode(GizmoMode.translate); break;
                        case 'rotate': gizmo.setMode(GizmoMode.rotate); break;
                        case 'scale': gizmo.setMode(GizmoMode.scale); break;
                    }
                };
                
                document.getElementById('coordMode').onchange = (e) => {
                    const mode = e.target.value;
                    gizmo.coordinateMode = mode === 'surface' ? CoordinateMode.surface : CoordinateMode.local;
                };
                
                // æ›´æ–°ä¿¡æ¯
                updateInfo();
                viewer.scene.preRender.addEventListener(updateInfo);
                
                document.getElementById('status').className = 'status success';
                const formatLabel = moduleFormat === 'esm' ? 'ESM' : 'UMD';
                document.getElementById('status').textContent = `âœ… [${formatLabel}] Cesium ${cesiumVersion} + Gizmo åŠ è½½æˆåŠŸ!`;
                
                // å¯¼å‡ºåˆ°å…¨å±€ä¾¿äºè°ƒè¯•
                window.viewer = viewer;
                window.model = model;
                window.gizmo = gizmo;
                window.Cesium = Cesium;
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                document.getElementById('status').className = 'status error';
                document.getElementById('status').textContent = `âŒ é”™è¯¯: ${error.message}`;
            }
        }
        
        function updateInfo() {
            if (!gizmo || !gizmo._mountedPrimitive) return;
            
            const mounted = gizmo._mountedPrimitive;
            
            // åç§°å’Œç±»å‹
            let name = '-', type = '-';
            if (mounted._isNode && mounted._node) {
                name = mounted._node.name || 'ModelNode';
                type = 'ModelNode';
            } else if (mounted instanceof Cesium.Model) {
                name = 'luaz.glb';
                type = 'Model';
            }
            
            document.getElementById('infoName').textContent = name;
            document.getElementById('infoType').textContent = type;
            
            // ä½ç½®
            try {
                const position = Cesium.Matrix4.getTranslation(mounted.modelMatrix, new Cesium.Cartesian3());
                const carto = Cesium.Cartographic.fromCartesian(position);
                if (carto) {
                    document.getElementById('infoLon').textContent = Cesium.Math.toDegrees(carto.longitude).toFixed(6);
                    document.getElementById('infoLat').textContent = Cesium.Math.toDegrees(carto.latitude).toFixed(6);
                    document.getElementById('infoHeight').textContent = carto.height.toFixed(2) + 'm';
                }
            } catch (e) {}
        }
    </script>
</body>
</html>
